<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sheets Lite (no formulas)</title>

  <!-- CSS Links -->
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="./map/stylesmap.css" />
  <link rel="stylesheet" href="./dropdown-menu.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>

  <!-- 1. PHẦN HEADER TRÊN CÙNG -->
  <div class="top-tabs-section">
    <div class="top-header-row">
      <!-- Menu Dropdown -->
      <div class="menu-dropdown">
        <button class="menu-trigger">
          <span class="hamburger-icon">☰</span>
          <span class="current-tab">Log chuyến</span>
        </button>
        
        <div class="dropdown-content">
          <button class="dropdown-item active" data-tab="logchuyen">Log chuyến</button>
          <button class="dropdown-item" data-tab="chamcong">Chấm công</button>
          <button class="dropdown-item" data-tab="congno">Công nợ</button>
          <button class="dropdown-item" data-tab="luong">Lương (tháng)</button>
  <button class="dropdown-item" data-tab="chuyen">Chuyến (tháng)</button>
  <button class="dropdown-item" data-tab="extra1" disabled>— Mở rộng 1</button>
  <button class="dropdown-item" data-tab="extra2" disabled>— Mở rộng 2</button>
  <button class="dropdown-item" data-tab="extra3" disabled>— Mở rộng 3</button>
        </div>
      </div>

      <div class="month-navigator">
        <button class="nav-btn" id="prevMonth" aria-label="Tháng trước">‹</button>
        <div id="monthDisplay" class="month-display"></div>
        <button class="nav-btn" id="nextMonth" aria-label="Tháng sau">›</button>
        
      </div>

      <!-- User Menu -->
      <!-- <div class="user-menu">
        <button class="user-trigger" id="userMenuTrigger">
          <svg class="user-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span class="user-name" id="userDisplay">User</span>
          <span class="user-role-badge" id="userRole">User</span>
        </button>
        
        <div class="user-dropdown" id="userDropdown">
          <div class="user-info">
            <div class="user-full-name" id="userFullName">Loading...</div>
            <div class="user-email" id="userEmail"></div>
          </div>
          <div class="dropdown-divider"></div>
          <button class="dropdown-item" id="changePasswordBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
            </svg>
            Đổi mật khẩu
          </button>
          <button class="dropdown-item" id="logoutBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Đăng xuất
          </button>
        </div>
      </div> -->

      
      <!-- Font Controls -->
      <div class="font-controls">
        <select id="fontFamily" title="Phông chữ">
          <option value="">Phông chữ</option>
          <option value="system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif">System</option>
          <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
          <option value="Roboto, Arial, sans-serif">Roboto</option>
          <option value="Arial, Helvetica, sans-serif">Arial</option>
          <option value="'Times New Roman', Times, serif">Times</option>
          <option value="'Courier New', Courier, monospace">Courier</option>
        </select>

        <select id="fontSize" title="Cỡ chữ">
          <option value="">Cỡ</option>
          <option>12</option><option>13</option><option>14</option>
          <option>16</option><option>18</option><option>20</option><option>22</option>
        </select>
      </div>
    </div>

  </div>

  <!-- 2. THANH CÔNG CỤ TOOLBAR -->
  <header class="toolbar" id="toolbar">
    <div class="group">
      <button data-action="undo" title="Hoàn tác (Ctrl+Z)">↶</button>
      <button data-action="redo" title="Làm lại (Ctrl+Y)">↷</button>

      <select id="formatMenu" title="Định dạng">
        <option value="">Định dạng</option>
        <option value="format.bold">Đậm (Ctrl+B)</option>
        <option value="format.italic">Nghiêng (Ctrl+I)</option>
        <option value="format.underline">Gạch chân (Ctrl+U)</option>
        <option value="clear.format">Xóa</option>
      </select>

      <select id="alignSelect" title="Căn lề">
        <option value="left">Trái</option>
        <option value="center">Giữa</option>
        <option value="right">Phải</option>
      </select>

      <label class="color"><span>Chữ</span><input type="color" id="textColor" /></label>
      <label class="color"><span>Nền</span><input type="color" id="fillColor" value="#ffffff" /></label>

      <select id="editMenu" title="Chỉnh sửa">
        <option value="">Chỉnh sửa ▾</option>
        <option value="row.insertBelow">+ Thêm hàng dưới (Ctrl+Enter)</option>
        <option value="col.insertRight">+ Thêm cột bên phải</option>
        <option value="row.delete">∸ Xóa hàng (Ctrl+Del)</option>
        <option value="col.delete">∸ Xóa cột</option>
        <option value="clear.cells">⌫ Xóa nội dung (Del)</option>
      </select>

      <div class="group filter-box" id="filterBox">
        <select id="filterCol" title="Chọn cột để lọc"></select>
        <input id="filterText" type="search" list="filterVals" placeholder="Gõ để lọc… (xóa chữ để bỏ lọc)" title="Nhập từ khóa lọc" />
        <datalist id="filterVals"></datalist>
	<button id="sortAZ" title="Sắp xếp A→Z">A→Z</button>
        <button id="sortZA" title="Sắp xếp Z→A">Z→A</button>
      </div>

      <button data-action="tools.cc2log">CC→Log</button>
      <button data-action="chuyen.compute">Chuyến (tính)</button>
      <button data-action="tools.tripSplit">Split chuyến</button>
      <button data-action="tools.assignTripId" title="Gán ID chuyến theo ngày">ID chuyến</button>
      <button id="btn-load">Tải dữ liệu</button>
      <button data-action="file.save" title="Lưu file đang mở (Ctrl+S)">Lưu</button>
      
      <!-- Data Operations Dropdown -->
<div class="data-ops-dropdown">
  <button class="data-ops-trigger">
    <span>Dữ liệu</span>
    <span class="dropdown-arrow">▾</span>
  </button>

  <div class="data-ops-content">
    <div class="ops-level" id="level-main">
      <button class="ops-item" data-action="capnhat">Cập nhật Thông tin</button>
      <button class="ops-item" data-action="updatefinal">Update</button>
      <button class="ops-item" data-action="taofile">Tạo file</button>
      <button class="ops-item" data-action="mucluong">Mức lương…</button>
    </div>
  </div>
</div>
      </div>

      <div id="ghost-actions" style="display:none">
        <button data-action="format.bold"></button>
        <button data-action="format.italic"></button>
        <button data-action="format.underline"></button>
        <button data-action="clear.format"></button>
        <button data-action="row.insertBelow"></button>
        <button data-action="col.insertRight"></button>
        <button data-action="row.delete"></button>
        <button data-action="col.delete"></button>
        <button data-action="clear.cells"></button>
      </div>
    </div>

    <label class="zoom">
      <input id="zoomPct" type="number" min="50" max="200" step="10" value="100" />%
    </label>
  </header>

  <!-- 3. PHẦN NỘI DUNG CHÍNH - WORKSPACE -->
  <main id="app" class="split">
    <section class="pane left" id="pane-data" aria-label="Bảng dữ liệu">
      <div class="sheet" id="sheet" tabindex="0" aria-label="Spreadsheet">
        <div class="table-wrap"></div>
      </div>
    </section>

    <div id="splitter" class="splitter" role="separator" aria-orientation="vertical" aria-label="Điều chỉnh tỉ lệ" tabindex="0"></div>

    <section class="pane right" id="pane-map" aria-label="Bản đồ">
      <div id="mapHost" class="map-host">
        <div class="map-placeholder">
          <p>Bản đồ</p>
          <small>Nhúng Leaflet vào #mapHost</small>
        </div>
      </div>
    </section>
  </main>

  <!-- 4. PHẦN FOOTER -->
<footer class="help">
  <div class="footer-line">
    <details id="shortcuts">
      <summary>Hướng dẫn & thao tác (mở để xem)</summary>
      <ul>
	<li>CC→Log: Dùng để import tài xế, phụ xe (đảm bảo rằng nhân viên đã chấm công bằng app)</li>
	<li>Split Trip: chức năng tạo chuyến bằng AI:
		+ chọn vùng có "Khách hàng" và "số lượng"
		+ Click → Msg hiện ra chọn số lượng → "Click OK" </li>
	<li>Id chuyến:
		+ chưa có sẽ tự tạo ID
		+ chọn khách hàng muốn ghép</li>


        <li>Di chuyển: ← ↑ → ↓, Tab/Shift+Tab, Enter/Shift+Enter</li>
        <li>Chọn mở rộng: Shift + phím mũi tên/chuột kéo</li>
        <li>Sửa ô: Enter hoặc F2; Xuống dòng trong ô: Alt+Enter; Hủy: Esc</li>
        <li>Copy/Cut/Paste: Ctrl+C / Ctrl+X / Ctrl+V (TSV)</li>
        <li>Định dạng: Ctrl+B / Ctrl+I / Ctrl+U; Căn lề: chọn ở combobox</li>
        <li>Thêm hàng dưới: Ctrl+Enter; Xóa hàng: Ctrl+Del</li>
        <li>Undo/Redo: Ctrl+Z / Ctrl+Y</li>
      </ul>
    </details>
    <div class="status-inline" aria-live="polite">
      <strong>Trạng thái</strong>
      <span id="status"></span>
    </div>
  </div>
</footer>

  <div id="table-host"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module" src="/auth.js?v=2"></script>
  <script type="module">
    // Check authentication before loading app
    import auth from '/auth.js';
    
    if (!auth.requireAuth()) {
      // Will redirect to login if not authenticated
      throw new Error('Authentication required');
    }
    
    // Update user display
    auth.updateUserDisplay();
    
    // Setup user menu
    const userMenuTrigger = document.getElementById('userMenuTrigger');
    const userDropdown = document.getElementById('userDropdown');
    const logoutBtn = document.getElementById('logoutBtn');
    
    userMenuTrigger?.addEventListener('click', (e) => {
      e.stopPropagation();
      userDropdown.classList.toggle('show');
    });
    
    document.addEventListener('click', () => {
      userDropdown?.classList.remove('show');
    });
    
    logoutBtn?.addEventListener('click', () => {
      auth.logout();
    });

    // Update user email display
    const user = auth.getUser();
    if (user && user.email) {
      const emailEl = document.getElementById('userEmail');
      if (emailEl) emailEl.textContent = user.email;
    }
    
    // Override fetch to use authenticated requests
    const originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
      // Skip auth for login and public endpoints
      if (url.includes('/api/auth/login') || url.includes('/login.html')) {
        return originalFetch(url, options);
      }
      
      // For API calls, add auth token
      if (url.startsWith('/api/') || url.startsWith('/filejson/')) {
        return auth.fetch(url, options);
      }
      
      return originalFetch(url, options);
    };
  </script>
  <script type="module" src="/config/config.js?v=2"></script>
  <script type="module" src="./monthly.js?v=2"></script>
  <script type="module" src="./menu.js?v=2"></script>
  
  <script type="module" src="./filemonth/dropdown-menu.js?v=2"></script>
  <script type="module" src="./map/map.js?v=2"></script>
  <script type="module" src="./main.js?v=2"></script>

</body>
</html>